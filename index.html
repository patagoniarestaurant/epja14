<!DOCTYPE html>
<html lang="es">
<head>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Patagonia Restaurant ‚Äî Men√∫ Digital</title>

<!-- Fuentes + FontAwesome -->
<link href="https://fonts.googleapis.com/css2?family=Sanchez&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<!-- jsPDF para comprobante -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- Firebase compat libs (ya us√°s compat en partes del c√≥digo) -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<!-- Google Translate -->
<script src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

<style>
  :root{
    --bg:#000000; --surface:#000000; --surface-light:#1a1a1a; --text:#ffffff;
    --text-muted:#a0a0a0; --accent:#d4af37; --accent-dark:#b8941f; --radius:12px;
    --border:rgba(255,255,255,0.08); --shadow:0 10px 25px rgba(0,0,0,0.5); --transition:all .25s ease;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%;font-family:'Sanchez',serif;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
  .container{max-width:1100px;margin:0 auto;padding:12px}
  header{position:sticky;top:0;background:rgba(0,0,0,.95);border-bottom:1px solid var(--border);padding:12px 0;z-index:100}
  .header-content{display:flex;align-items:center;justify-content:space-between}
  .brand{display:flex;gap:12px;align-items:center}
  .hamburger-menu{display:flex;flex-direction:column;gap:4px;cursor:pointer;padding:6px}
  .hamburger-menu span{width:22px;height:2px;background:var(--accent)}
  .restaurant-cover{width:60px;height:50px;border-radius:8px;object-fit:cover;border:2px solid var(--accent)}
  .brand-text h1{font-size:16px;color:var(--text)}
  .nav-buttons{display:flex;gap:10px;margin:12px 0}
  .nav-btn{background:var(--accent);color:var(--text);padding:10px 12px;border-radius:10px;border:1px solid var(--accent);cursor:pointer;transition:var(--transition)}
  .nav-btn:hover{background:var(--accent-dark)}
  .view{display:none}
  .view.active{display:block}
  .cover-image{width:100%;height:150px;object-fit:cover;border-radius:var(--radius);margin-bottom:12px}
  .profile-section{text-align:center;margin-bottom:12px}
  .profile-image{width:100px;height:100px;border-radius:50%;object-fit:cover;border:4px solid var(--accent);margin:0 auto 8px}
  .contact-info,.hours-section,.customer-category,.category-section{background:var(--surface);padding:12px;border-radius:12px;margin-bottom:12px;border:1px solid var(--border)}
  .menu-section{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  .dishes-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  .dish-card{background:var(--surface-light);border-radius:12px;overflow:hidden;border:1px solid var(--border);display:flex;flex-direction:column;cursor:pointer;aspect-ratio:1;transition:var(--transition)}
  .dish-card.selected{border:2px solid var(--accent);box-shadow:0 0 15px var(--accent)}
  .dish-image{height:65%;position:relative}
  .dish-image img{width:100%;height:100%;object-fit:cover}
  .dish-content{padding:8px;display:flex;flex-direction:column;justify-content:space-between;flex:1}
  .dish-header{display:flex;justify-content:space-between;align-items:flex-start}
  .dish-name{font-weight:700;color:var(--accent)}
  .dish-price{color:var(--accent);font-weight:800}
  .dish-actions{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
  .qty-btn{width:28px;height:28px;border-radius:50%;border:1px solid var(--border);background:transparent;cursor:pointer;color:var(--accent)}
  .add-to-cart-btn{background:var(--accent);color:var(--bg);border:none;padding:6px 10px;border-radius:10px;cursor:pointer}
  .sidebar-nav{position:fixed;left:-320px;top:0;width:320px;height:100vh;background:var(--surface);padding:12px;border-right:1px solid var(--border);transition:var(--transition);z-index:1200;overflow-y:auto}
  .sidebar-nav.open{left:0}
  .sidebar-overlay{position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.5);opacity:0;visibility:hidden;transition:var(--transition);z-index:1100}
  .sidebar-overlay.open{opacity:1;visibility:visible}
  .cart-sidebar{position:fixed;right:-100%;top:0;width:100%;max-width:420px;height:100vh;background:var(--surface);padding:12px;border-left:1px solid var(--border);transition:var(--transition);z-index:1300}
  .cart-sidebar.open{right:0}
  .cart-overlay{position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.5);opacity:0;visibility:hidden;transition:var(--transition);z-index:1250}
  .cart-overlay.open{opacity:1;visibility:visible}
  .modal,.dish-detail-modal,.payment-choice-modal,.registration-modal,.login-modal{position:fixed;left:0;top:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.7);z-index:1400;opacity:0;visibility:hidden;transition:var(--transition)}
  .modal.open,.dish-detail-modal.open,.payment-choice-modal.open,.registration-modal.open,.login-modal.open{opacity:1;visibility:visible}
  .modal-content,.dish-detail-content{background:var(--surface);padding:16px;border-radius:12px;max-width:520px;width:95%;max-height:90vh;overflow:auto}
  .calculator{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
  .calculator-display{grid-column:1/-1;background:var(--surface-light);padding:10px;border-radius:8px;border:1px solid var(--border);text-align:right}
  .calculator-btn{padding:12px;border-radius:8px;border:1px solid var(--border);background:transparent;cursor:pointer;color:var(--accent)}
  .toast{position:fixed;right:16px;bottom:16px;padding:10px 14px;border-radius:8px;background:var(--surface);border-left:4px solid var(--accent);transform:translateY(40px);opacity:0;transition:var(--transition);z-index:1600}
  .toast.show{transform:translateY(0);opacity:1}
  .hidden{display:none!important}
  footer{background:var(--surface);padding:20px;margin-top:20px;border-top:1px solid var(--border);text-align:center}
  .customer-categories{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  .customer-category{background:var(--surface);padding:12px;border-radius:12px;border:1px solid var(--border)}
  .customer-category h3{color:var(--accent);text-align:center;margin-bottom:8px}
  .customer-item{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border)}
  .customer-item:last-child{border-bottom:none}
  .customer-name{color:var(--text)}
  .customer-score{color:var(--accent);font-weight:700}
  .filter-section{background:var(--surface);padding:12px;border-radius:12px;margin-bottom:12px;border:1px solid var(--border)}
  .filter-options{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .filter-tag{background:var(--surface-light);color:var(--text);padding:6px 12px;border-radius:20px;border:1px solid var(--border);cursor:pointer;transition:var(--transition)}
  .filter-tag.selected{background:var(--accent);color:var(--bg)}
  .split-calculator{margin-top:12px;padding:12px;background:var(--surface-light);border-radius:8px;border:1px solid var(--border)}
  .split-options{display:grid;grid-template-columns:repeat(6,1fr);gap:6px;margin-top:8px}
  .split-option{background:var(--surface);color:var(--text);padding:8px;border-radius:8px;border:1px solid var(--border);cursor:pointer;text-align:center;transition:var(--transition)}
  .split-option.selected{background:var(--accent);color:var(--bg)}
  .category-carousel{display:flex;overflow-x:auto;gap:12px;padding:8px 0;scroll-snap-type:x mandatory}
  .category-carousel::-webkit-scrollbar{height:6px}
  .category-carousel::-webkit-scrollbar-track{background:var(--surface-light);border-radius:3px}
  .category-carousel::-webkit-scrollbar-thumb{background:var(--accent);border-radius:3px}
  .category-carousel-item{flex:0 0 auto;width:calc(50% - 6px);scroll-snap-align:start}
  .favorites-section{margin-top:16px;padding-top:16px;border-top:1px solid var(--border)}
  .favorite-item{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border)}
  .favorite-item:last-child{border-bottom:none}
  .favorite-vote{display:flex;gap:4px;align-items:center}
  .vote-btn{background:transparent;border:none;color:var(--accent);cursor:pointer;font-size:16px}
  .vote-count{min-width:20px;text-align:center}
  .price-inputs{display:flex;gap:8px}
  .price-inputs input{flex:1;padding:8px;border-radius:8px;background:var(--surface-light);border:1px solid var(--border);color:var(--text);width:100%}
  .language-selector{position:fixed;top:10px;right:10px;z-index:1000}
  .language-selector select{padding:6px 10px;border-radius:8px;background:var(--surface);color:var(--text);border:1px solid var(--border);cursor:pointer}
  @media(max-width:800px){
    .menu-section,.dishes-grid{grid-template-columns:repeat(1,1fr)} 
    .dish-card{aspect-ratio:1.5} 
    .restaurant-cover{display:none}
    .customer-categories{grid-template-columns:1fr}
    .split-options{grid-template-columns:repeat(3,1fr)}
    .category-carousel-item{width:calc(100% - 6px)}
    .language-selector{right:10px;top:80px}
  }
  @media(max-width:480px){
    .dishes-grid{grid-template-columns:repeat(2,1fr)}
    .dish-card{aspect-ratio:1}
    .category-carousel-item{width:calc(100% - 6px)}
  }

  /* Google Translate Styles */
  .goog-te-banner-frame { display: none !important; }
  .goog-te-gadget-simple { background: var(--surface) !important; border: 1px solid var(--border) !important; padding: 6px 10px !important; border-radius: 8px !important; }
  .goog-te-gadget-simple span { color: var(--text) !important; }
  .goog-te-menu-value span { color: var(--text) !important; }
  .goog-te-menu2 { background: var(--surface) !important; border: 1px solid var(--border) !important; }
  .goog-te-menu2-item div, .goog-te-menu2-item-selected div { color: var(--text) !important; }
  .goog-te-menu2-item:hover { background: var(--surface-light) !important; }
  #google_translate_element { position: fixed; top: 10px; right: 10px; z-index: 1000; }
  body { top: 0px !important; }
</style>

<script>
  // CONFIGURACI√ìN DE FIREBASE
  const firebaseConfig = {
    apiKey: "AIzaSyBSTjM-uPnnqIvcDBkpf71yxF6ajga1db0",
    authDomain: "patagoniarestaurant-783c3.firebaseapp.com",
    databaseURL: "https://patagoniarestaurant-783c3-default-rtdb.firebaseio.com",
    projectId: "patagoniarestaurant-783c3",
    storageBucket: "patagoniarestaurant-783c3.firebasestorage.app",
    messagingSenderId: "303237107477",
    appId: "1:303237107477:web:67591dad3e4244d434a31c"
  };

  // Inicializar Firebase (compat)
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Google Translate
  function googleTranslateElementInit() {
    new google.translate.TranslateElement({
      pageLanguage: 'es',
      includedLanguages: 'es,en,fr,de,it,pt,ja,zh,ru,ar',
      layout: google.translate.TranslateElement.InlineLayout.SIMPLE,
      autoDisplay: false
    }, 'google_translate_element');
  }
</script>
</head>
<body>

<!-- TOAST -->
<div id="toast" class="toast"></div>

<!-- Google Translate -->
<div id="google_translate_element"></div>

<!-- SIDEBAR -->
<div id="sidebarOverlay" class="sidebar-overlay"></div>
<aside id="sidebarNav" class="sidebar-nav" aria-hidden="true">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
    <h3 style="color:var(--accent)">Men√∫</h3>
    <button id="closeSidebar" class="nav-btn"><i class="fas fa-times"></i></button>
  </div>

  <div style="margin-bottom:10px;display:flex;flex-direction:column;gap:8px">
    <button id="sidebarLoginBtn" class="nav-btn"><i class="fas fa-sign-in-alt"></i> Iniciar Sesi√≥n</button>
    <button id="sidebarRegisterBtn" class="nav-btn"><i class="fas fa-user-plus"></i> Registrarse</button>
  </div>

  <div style="margin-bottom:10px">
    <div style="position:relative">
      <i class="fas fa-search" style="position:absolute;left:10px;top:10px;color:var(--text-muted)"></i>
      <input id="sidebarSearch" style="width:100%;padding:10px 12px 10px 36px;border-radius:8px;background:var(--surface-light);border:1px solid var(--border);color:var(--text)" placeholder="Buscar platos...">
    </div>
  </div>

  <div class="filter-section">
    <h4 style="color:var(--accent);margin-bottom:8px">Filtrar por precio</h4>
    <div class="price-inputs">
      <input id="minPrice" type="number" placeholder="M√≠n" style="width:100%">
      <input id="maxPrice" type="number" placeholder="M√°x" style="width:100%">
    </div>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="applyPriceFilter" class="nav-btn" style="flex:1">Aplicar</button>
      <button id="clearPriceFilter" class="nav-btn" style="flex:1">Limpiar</button>
    </div>
  </div>

  <div class="filter-section">
    <h4 style="color:var(--accent);margin-bottom:8px">Etiquetas de alimentos</h4>
    <div class="filter-options" id="foodTags">
      <div class="filter-tag" data-tag="vegetariano">Vegetariano</div>
      <div class="filter-tag" data-tag="vegano">Vegano</div>
      <div class="filter-tag" data-tag="sin-gluten">Sin Gluten</div>
      <div class="filter-tag" data-tag="picante">Picante</div>
      <div class="filter-tag" data-tag="bajo-calorias">Bajo Calor√≠as</div>
    </div>
  </div>

  <div id="categoriesSidebar" style="display:flex;flex-direction:column;gap:8px"></div>

  <div class="favorites-section">
    <h4 style="color:var(--accent);margin-bottom:8px">Platos Favoritos</h4>
    <div id="favoritesList"></div>
  </div>
</aside>

<!-- CART -->
<div id="cartOverlay" class="cart-overlay"></div>
<aside id="cartSidebar" class="cart-sidebar" aria-hidden="true">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
    <h3 style="color:var(--accent)">Tu Pedido</h3>
    <button id="closeCart" class="nav-btn"><i class="fas fa-times"></i></button>
  </div>
  <div id="cartItems" style="max-height:55vh;overflow:auto"></div>
  <div style="border-top:1px solid var(--border);padding-top:12px;margin-top:12px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <strong>Total:</strong><strong id="cartTotal">$0</strong>
    </div>
    <button id="checkoutBtn" class="nav-btn" style="width:100%;background:var(--accent);color:var(--bg)">Proceder al Pago</button>
    <div id="pendingPayment" class="hidden" style="margin-top:12px">
      <div style="padding:10px;border:1px solid var(--accent);border-radius:8px">Pago Pendiente</div>
      <button id="requestBillBtn" class="nav-btn" style="width:100%;margin-top:8px"><i class="fas fa-receipt"></i> Pedir la Cuenta</button>
    </div>
  </div>
</aside>

<header>
  <div class="container">
    <div class="header-content">
      <div class="brand">
        <div id="hamburgerMenu" class="hamburger-menu" title="Abrir men√∫">
          <span></span><span></span><span></span>
        </div>
        <img id="headerRestaurantImage" class="restaurant-cover" src="https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?auto=format&fit=crop&w=500&q=80" alt="Patagonia">
        <div class="brand-text">
          <h1 id="headerTitle">Patagonia Restaurant</h1>
          <div id="headerSlogan" style="font-size:12px;color:var(--text-muted)">Sabores sin fronteras, experiencia sin l√≠mites</div>
        </div>
      </div>

      <div style="display:flex;align-items:center;gap:12px">
        <button id="cartIcon" class="nav-btn" title="Abrir carrito"><i class="fas fa-shopping-cart"></i><span id="cartCount" style="background:var(--accent);color:var(--text);border-radius:50%;padding:2px 6px;margin-left:6px">0</span></button>
      </div>
    </div>
  </div>
</header>

<main class="container">
  <div class="nav-buttons">
    <button id="backBtn" class="nav-btn"><i class="fas fa-arrow-left"></i> Retroceder</button>
    <button id="homeBtn" class="nav-btn"><i class="fas fa-home"></i> Men√∫ Principal</button>
    <button id="menuBtn" class="nav-btn"><i class="fas fa-utensils"></i> Ver Men√∫ Digital</button>
  </div>

  <!-- HOME VIEW -->
  <section id="homeView" class="view active">
    <img id="coverImage" class="cover-image" src="https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?auto=format&fit=crop&w=2000&q=80" alt="Cover">
    <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px">
      <div style="display:flex;gap:8px;align-items:center">
        <div style="width:10px;height:10px;border-radius:50%;background:var(--accent)"></div>
        <div id="statusText" style="color:var(--text-muted)">Abierto</div>
      </div>
      <button id="callWaiterBtn" class="nav-btn" style="margin-left:auto"><i class="fas fa-bell"></i> Llamar al Mozo</button>
    </div>

    <div class="profile-section">
      <img id="profileImage" class="profile-image" src="https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?auto=format&fit=crop&w=500&q=80" alt="Profile">
      <h2 id="profileName" style="color:var(--text)">Patagonia Restaurant</h2>
      <p id="profileSlogan" style="color:var(--text-muted)">Sabores sin fronteras, experiencia sin l√≠mites</p>
    </div>

    <section class="contact-info">
      <h3 style="color:var(--text)">Contacto</h3>
      <div style="display:grid;gap:8px;margin-top:8px">
        <div style="display:flex;gap:8px;align-items:center">
          <i class="fab fa-whatsapp" style="background:var(--accent);padding:8px;border-radius:8px"></i>
          <div><div style="font-size:12px;color:var(--text-muted)">WhatsApp</div><a class="contact-link" href="https://wa.me/542974705984" target="_blank" style="color:var(--text)">+54 297 470-5984</a></div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <i class="fab fa-instagram" style="background:var(--accent);padding:8px;border-radius:8px"></i>
          <div><div style="font-size:12px;color:var(--text-muted)">Instagram</div><a class="contact-link" href="https://instagram.com/patagoniarestaurant" target="_blank" style="color:var(--text)">@patagoniarestaurant</a></div>
        </div>
      </div>
    </section>

    <section id="hoursSection" class="hours-section">
      <h3 style="color:var(--text)">Horarios de Atenci√≥n</h3>
      <div id="hoursList" style="margin-top:8px"></div>
    </section>

    <section id="customerCategories" class="customer-categories"></section>
  </section>

  <!-- MENU VIEW -->
  <section id="menuView" class="view">
    <section id="menuSection" class="menu-section"></section>
  </section>
</main>

<footer>
  <div class="container">
    <div style="color:var(--text-muted);font-size:13px">Patagonia Restaurant ‚Äî Las Heras, Santa Cruz ‚Ä¢ Domingo F. Sarmiento 494 ‚Ä¢ Tel: 2974705984</div>
    <div style="margin-top:8px;color:var(--text-muted)">¬© 2025 Patagonia Restaurant. Todos los derechos reservados.</div>
  </div>
</footer>

<!-- Dish detail modal -->
<div id="dishDetailModal" class="dish-detail-modal" aria-hidden="true">
  <div class="dish-detail-content">
    <div style="position:relative">
      <img id="detailImage" src="" alt="Detalle" style="width:100%;height:220px;object-fit:cover;border-radius:8px">
      <button id="closeDetail" class="nav-btn" style="position:absolute;top:10px;right:10px"><i class="fas fa-times"></i></button>
    </div>
    <div style="padding-top:12px">
      <h3 id="detailName" style="color:var(--accent)"></h3>
      <div id="detailPrice" style="font-weight:700;color:var(--accent);margin-bottom:8px"></div>
      <p id="detailDescription" style="color:var(--text-muted)"></p>
      <div id="detailTags" style="display:flex;gap:4px;margin:8px 0;flex-wrap:wrap"></div>

      <div style="display:flex;gap:12px;align-items:center;margin-top:12px">
        <div style="display:flex;gap:8px;align-items:center">
          <button id="detailDecrease" class="qty-btn"><i class="fas fa-minus"></i></button>
          <span id="detailQuantity" style="min-width:26px;text-align:center;font-weight:700">1</span>
          <button id="detailIncrease" class="qty-btn"><i class="fas fa-plus"></i></button>
        </div>
        <button id="detailAddToCart" class="add-to-cart-btn"><i class="fas fa-shopping-cart"></i> Agregar</button>
      </div>
      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="detailReset" class="nav-btn" style="flex:1">Restablecer</button>
        <button id="detailFavorite" class="nav-btn" style="flex:1"><i class="far fa-heart"></i> Favorito</button>
      </div>
    </div>
  </div>
</div>

<!-- Payment choice modal -->
<div id="paymentChoiceModal" class="payment-choice-modal">
  <div class="modal-content">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 style="color:var(--accent)">Opciones de Pago</h3>
      <button id="closePaymentChoice" class="nav-btn"><i class="fas fa-times"></i></button>
    </div>

    <div style="display:grid;gap:10px;margin-top:12px">
      <div class="nav-btn payment-choice-option" data-choice="now"><i class="fas fa-credit-card"></i> Pagar Ahora</div>
      <div class="nav-btn payment-choice-option" data-choice="later"><i class="fas fa-clock"></i> Pagar al Finalizar</div>
    </div>

    <!-- Calculator -->
    <div class="split-calculator">
      <h4 style="color:var(--accent);margin-bottom:8px">Dividir la cuenta</h4>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div>Total:</div>
        <div id="splitTotal" style="font-weight:700;color:var(--accent)">$0</div>
      </div>
      <div>Dividir entre:</div>
      <div class="split-options">
        <div class="split-option" data-split="1">1</div>
        <div class="split-option" data-split="2">2</div>
        <div class="split-option" data-split="3">3</div>
        <div class="split-option" data-split="4">4</div>
        <div class="split-option" data-split="5">5</div>
        <div class="split-option" data-split="6">6</div>
        <div class="split-option" data-split="7">7</div>
        <div class="split-option" data-split="8">8</div>
        <div class="split-option" data-split="9">9</div>
        <div class="split-option" data-split="10">10</div>
        <div class="split-option" data-split="11">11</div>
        <div class="split-option" data-split="12">12</div>
      </div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
        <div>Total por persona:</div>
        <div id="splitPerPerson" style="font-weight:700;color:var(--accent)">$0</div>
      </div>
    </div>

    <div style="display:flex;gap:8px;margin-top:12px">
      <button id="confirmPaymentChoice" class="nav-btn" style="flex:1;background:var(--accent);color:var(--bg)"><i class="fas fa-check"></i> Confirmar</button>
      <button id="cancelPaymentChoice" class="nav-btn" style="flex:1">Cancelar</button>
    </div>
  </div>
</div>

<!-- Payment modal -->
<div id="paymentModal" class="modal" aria-hidden="true">
  <div class="modal-content">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 style="color:var(--accent)">M√©todo de Pago</h3>
      <button id="closePayment" class="nav-btn"><i class="fas fa-times"></i></button>
    </div>

    <div style="display:grid;gap:8px;margin-top:12px">
      <div class="nav-btn payment-option" data-method="mercado-pago"><i class="fas fa-credit-card"></i> Mercado Pago (real / sandbox)</div>
      <div class="nav-btn payment-option" data-method="transferencia"><i class="fas fa-university"></i> Transferencia Bancaria</div>
      <div class="nav-btn payment-option" data-method="debito"><i class="fas fa-credit-card"></i> Tarjeta D√©bito (local)</div>
    </div>

    <div style="margin-top:12px">
      <label style="color:var(--text-muted)">Propina</label>
      <div style="display:flex;gap:8px;margin-top:8px">
        <div class="nav-btn tip-option" data-tip="0">No dejar</div>
        <div class="nav-btn tip-option" data-tip="5">5%</div>
        <div class="nav-btn tip-option" data-tip="10">10%</div>
        <div class="nav-btn tip-option" data-tip="15">15%</div>
      </div>
    </div>

    <div id="paymentReceipt" class="receipt" style="margin-top:12px;background:var(--surface-light);padding:10px;border-radius:8px"></div>

    <div style="display:flex;gap:8px;margin-top:12px">
      <button id="confirmPayment" class="nav-btn" style="flex:1;background:var(--accent);color:var(--bg)"><i class="fas fa-check"></i> Confirmar Pago</button>
      <button id="cancelPayment" class="nav-btn" style="flex:1">Cancelar</button>
    </div>
  </div>
</div>

<!-- Registration modal -->
<div id="registrationModal" class="registration-modal" aria-hidden="true">
  <div class="registration-content">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 style="color:var(--accent)">Registro</h3>
      <button id="closeRegistration" class="nav-btn"><i class="fas fa-times"></i></button>
    </div>

    <div style="margin-top:12px">
      <label class="form-label">N√∫mero de celular</label>
      <input id="phoneNumber" class="form-input" placeholder="+54 9 11 1234-5678" style="width:100%;padding:10px;border-radius:8px;background:var(--surface-light);border:1px solid var(--border);color:var(--text)">
    </div>
    <div style="margin-top:8px">
      <label class="form-label">Contrase√±a</label>
      <input id="password" type="password" class="form-input" placeholder="Contrase√±a" style="width:100%;padding:10px;border-radius:8px;background:var(--surface-light);border:1px solid var(--border);color:var(--text)">
    </div>
    <div style="margin-top:8px">
      <label class="form-label">Alias (opcional)</label>
      <input id="alias" class="form-input" placeholder="Alias" style="width:100%;padding:10px;border-radius:8px;background:var(--surface-light);border:1px solid var(--border);color:var(--text)">
    </div>
    <div style="display:flex;gap:8px;margin-top:12px">
      <button id="sendVerificationCode" class="nav-btn" style="flex:1;background:var(--accent);color:var(--bg)">Enviar C√≥digo</button>
      <button id="cancelRegistration" class="nav-btn" style="flex:1">Cancelar</button>
    </div>

    <div id="verificationSection" class="hidden" style="margin-top:12px">
      <label class="form-label">C√≥digo de verificaci√≥n</label>
      <input id="verificationCode" class="form-input" placeholder="123456" maxlength="6" style="width:100%;padding:10px;border-radius:8px;background:var(--surface-light);border:1px solid var(--border);color:var(--text)">
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="verifyCode" class="nav-btn" style="flex:1;background:var(--accent);color:var(--bg)">Verificar</button>
      </div>
    </div>
  </div>
</div>

<!-- Login modal -->
<div id="loginModal" class="login-modal" aria-hidden="true">
  <div class="login-content">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 style="color:var(--accent)">Iniciar Sesi√≥n</h3>
      <button id="closeLogin" class="nav-btn"><i class="fas fa-times"></i></button>
    </div>

    <div style="margin-top:12px">
      <label>N√∫mero de celular</label>
      <input id="loginPhone" class="form-input" placeholder="+54 9 11 1234-5678" style="width:100%;padding:10px;border-radius:8px;background:var(--surface-light);border:1px solid var(--border);color:var(--text)">
    </div>
    <div style="margin-top:8px">
      <label>Contrase√±a</label>
      <input id="loginPassword" type="password" class="form-input" placeholder="Contrase√±a" style="width:100%;padding:10px;border-radius:8px;background:var(--surface-light);border:1px solid var(--border);color:var(--text)">
    </div>
    <div style="display:flex;gap:8px;margin-top:12px">
      <button id="loginBtn" class="nav-btn" style="flex:1;background:var(--accent);color:var(--bg)"><i class="fas fa-sign-in-alt"></i> Iniciar</button>
      <button id="cancelLogin" class="nav-btn" style="flex:1">Cancelar</button>
    </div>
  </div>
</div>

<script>
/* ============================
   CONFIG: Cambiar al desplegar
   ============================ */
const BACKEND_URL = "http://localhost:3000";

/* ============================
   SISTEMA FIREBASE - TIEMPO REAL
   ============================ */

// Datos en tiempo real desde Firebase (se sobrescribir√°n si Firebase responde)
let restaurantData = {
    name: "Patagonia Restaurant",
    slogan: "Sabores sin fronteras, experiencia sin l√≠mites",
    phone: "+54 297 470-5984",
    whatsapp: "+54 297 470-5984", 
    instagram: "@patagoniarestaurant",
    address: "Domingo F. Sarmiento 494, Las Heras, Santa Cruz",
    hours: []
};

let firebaseMenuData = {
    categories: [],
    dishes: []
};

/* ============================
   Datos del men√∫ (respaldo)
   ============================ */
const MENU_DATA = {
  restaurant: 'Patagonia Restaurant',
  slogan: 'Sabores sin fronteras, experiencia sin l√≠mites',
  coverImage: 'https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?auto=format&fit=crop&w=2000&q=80',
  profileImage: 'https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?auto=format&fit=crop&w=500&q=80',
  hours: [
    {day:'Lunes', time:'Cerrado'},
    {day:'Martes', time:'18:00 - 23:00'},
    {day:'Mi√©rcoles', time:'18:00 - 23:00'},
    {day:'Jueves', time:'18:00 - 23:00'},
    {day:'Viernes', time:'18:00 - 01:00'},
    {day:'S√°bado', time:'12:00 - 01:00'},
    {day:'Domingo', time:'12:00 - 18:00'}
  ],
  categories: [
    { id:'especialidad-chef', name:'Especialidad del Chef', subcategories: [
      { id:'platos-casa', name:'Platos de la Casa' },
      { id:'postres-casa', name:'Postres de la Casa' }
    ]},
    { id:'principales', name:'Platos Principales' },
    { id:'bebidas-sin-alcohol', name:'Bebidas sin Alcohol' },
    { id:'acompanamientos', name:'Acompa√±amientos' },
    { id:'aperitivos', name:'Aperitivos' },
    { id:'postres', name:'Postres' },
    { id:'te-infusiones', name:'T√© e Infusiones' },
    { id:'cafe', name:'Caf√©' },
    { id:'jugos', name:'Jugos' },
    { id:'vinos', name:'Vinos' },
    { id:'tragos', name:'Tragos' }
  ],
  dishes: [
    { id:'d1', name:'Provoleta a la parrilla', price:1200, category:'platos-casa', description:'Provoleta con or√©gano y chimichurri', img:'https://images.unsplash.com/photo-1628071237366-ea5d0f1b2e94?auto=format&fit=crop&w=800&q=60', tags:['vegetariano', 'sin-gluten'] },
    { id:'d2', name:'Empanadas de carne', price:350, category:'platos-casa', description:'Empanadas tradicionales', img:'https://images.unsplash.com/photo-1544025162-d76694265947?auto=format&fit=crop&w=800&q=60', tags:[] },
    { id:'d3', name:'Postre de la casa', price:900, category:'postres-casa', description:'Chocolate, frutos rojos y crema', img:'https://images.unsplash.com/photo-1551782450-a2132b4ba21d?auto=format&fit=crop&w=800&q=60', tags:['vegetariano'] },
    { id:'d4', name:'Flan casero', price:750, category:'postres-casa', description:'Flan con dulce de leche', img:'https://images.unsplash.com/photo-1578985545062-69928b1d9587?auto=format&fit=crop&w=800&q=60', tags:['vegetariano'] },
    { id:'d5', name:'Asado Patagonia (porci√≥n)', price:4200, category:'principales', description:'Corte seleccionado, acompa√±ado de papas calientes', img:'https://images.unsplash.com/photo-1604908177522-89f13d0b0fda?auto=format&fit=crop&w=800&q=60', tags:[] },
    { id:'d6', name:'Salm√≥n al horno', price:3800, category:'principales', description:'Salm√≥n fresco con emulsi√≥n c√≠trica', img:'https://images.unsplash.com/photo-1544025162-3e5a6cb4b1f6?auto=format&fit=crop&w=800&q=60', tags:['bajo-calorias'] },
    { id:'d7', name:'Agua mineral', price:300, category:'bebidas-sin-alcohol', description:'Agua mineral 500ml', img:'https://images.unsplash.com/photo-1548839148-108717728f7f?auto=format&fit=crop&w=800&q=60', tags:['vegano', 'sin-gluten'] },
    { id:'d8', name:'Gaseosa', price:400, category:'bebidas-sin-alcohol', description:'Gaseosa 500ml', img:'https://images.unsplash.com/photo-1621506289937-a8e4df240d0b?auto=format&fit=crop&w=800&q=60', tags:['vegano', 'sin-gluten'] },
    { id:'d9', name:'Papas fritas', price:600, category:'acompanamientos', description:'Papas fritas crujientes', img:'https://images.unsplash.com/photo-1573080496219-bb080dd4f877?auto=format&fit=crop&w=800&q=60', tags:['vegetariano', 'vegano'] },
    { id:'d10', name:'Ensalada mixta', price:500, category:'acompanamientos', description:'Lechuga, tomate y cebolla', img:'https://images.unsplash.com/photo-1540420773420-3366772f4999?auto=format&fit=crop&w=800&q=60', tags:['vegetariano', 'vegano', 'bajo-calorias'] },
    { id:'d11', name:'Aceitunas', price:350, category:'aperitivos', description:'Aceitunas verdes y negras', img:'https://images.unsplash.com/photo-1608039755407-31c2f7f1d3ca?auto=format&fit=crop&w=800&q=60', tags:['vegetariano', 'vegano'] },
    { id:'d12', name:'Pan con ajo', price:450, category:'aperitivos', description:'Pan tostado con ajo y perejil', img:'https://images.unsplash.com/photo-1573140247632-f8fd74997d5c?auto=format&fit=crop&w=800&q=60', tags:['vegetariano'] },
    { id:'d13', name:'Tiramis√∫', price:950, category:'postres', description:'Postre italiano con caf√© y cacao', img:'https://images.unsplash.com/photo-1571877227200-a0d98ea607e9?auto=format&fit=crop&w=800&q=60', tags:['vegetariano'] },
    { id:'d14', name:'Cheesecake', price:850, category:'postres', description:'Tarta de queso con frutos rojos', img:'https://images.unsplash.com/photo-1524351199678-941a58a3df50?auto=format&fit=crop&w=800&q=60', tags:['vegetariano'] },
    { id:'d15', name:'T√© negro', price:250, category:'te-infusiones', description:'T√© negro de calidad premium', img:'https://images.unsplash.com/photo-1556679343-c7306c1976bc?auto=format&fit=crop&w=800&q=60', tags:['vegano', 'sin-gluten'] },
    { id:'d16', name:'Manzanilla', price:250, category:'te-infusiones', description:'Infusi√≥n de manzanilla relajante', img:'https://images.unsplash.com/photo-1597481499750-3e11b3e6c6c9?auto=format&fit=crop&w=800&q=60', tags:['vegano', 'sin-gluten'] },
    { id:'d17', name:'Caf√© espresso', price:300, category:'cafe', description:'Caf√© espresso intenso', img:'https://images.unsplash.com/photo-1514432324607-a09d9b4aefdd?auto=format&fit=crop&w=800&q=60', tags:['vegano', 'sin-gluten'] },
    { id:'d18', name:'Cappuccino', price:450, category:'cafe', description:'Caf√© con leche espumosa', img:'https://images.unsplash.com/photo-1572442388796-11668a67e53d?auto=format&fit=crop&w=800&q=60', tags:['vegetariano'] },
    { id:'d19', name:'Jugo de naranja', price:400, category:'jugos', description:'Jugo de naranja natural', img:'https://images.unsplash.com/photo-1613478223719-2ab802602423?auto=format&fit=crop&w=800&q=60', tags:['vegano', 'sin-gluten'] },
    { id:'d20', name:'Jugo de manzana', price:400, category:'jugos', description:'Jugo de manzana natural', img:'https://images.unsplash.com/photo-1621506289937-a8e4df240d0b?auto=format&fit=crop&w=800&q=60', tags:['vegano', 'sin-gluten'] },
    { id:'d21', name:'Malbec', price:1200, category:'vinos', description:'Vino tinto Malbec argentino', img:'https://images.unsplash.com/photo-1506377247377-2a5b3b417ebb?auto=format&fit=crop&w=800&q=60', tags:['vegano', 'sin-gluten'] },
    { id:'d22', name:'Chardonnay', price:1300, category:'vinos', description:'Vino blanco Chardonnay', img:'https://images.unsplash.com/photo-1510812431401-41d2bd2722f3?auto=format&fit=crop&w=800&q=60', tags:['vegano', 'sin-gluten'] },
    { id:'d23', name:'Fernet con cola', price:800, category:'tragos', description:'Fernet Branca con Coca-Cola', img:'https://images.unsplash.com/photo-1544145945-f90425340c7e?auto=format&fit=crop&w=800&q=60', tags:[] },
    { id:'d24', name:'Gin Tonic', price:900, category:'tragos', description:'Gin con agua t√≥nica y lima', img:'https://images.unsplash.com/photo-1605270012917-bf157c5a9541?auto=format&fit=crop&w=800&q=60', tags:[] }
  ]
};

/* ======== Estado y utilidades ======== */
let state = {
  cart: JSON.parse(localStorage.getItem('cart_v1')) || {},
  favorites: JSON.parse(localStorage.getItem('fav_v1')) || {},
  user: JSON.parse(localStorage.getItem('user_v1')) || null,
  paymentChoice: null,
  paymentMethod: null,
  tipPercent: 0,
  selectedTags: [],
  dishVotes: JSON.parse(localStorage.getItem('dish_votes_v1')) || {},
  lastReceiptLines: [],
  lastReceiptTotals: { subtotal:0, tip:0, total:0 }
};

function saveState(){
  localStorage.setItem('cart_v1', JSON.stringify(state.cart));
  localStorage.setItem('fav_v1', JSON.stringify(state.favorites));
  localStorage.setItem('user_v1', JSON.stringify(state.user));
  localStorage.setItem('dish_votes_v1', JSON.stringify(state.dishVotes));
}

function toast(message, type='success'){
  const t = document.getElementById('toast');
  t.textContent = message;
  t.classList.add('show');
  if(type==='error'){ t.style.borderLeft='4px solid #ef4444'; } else { t.style.borderLeft='4px solid var(--accent)'; }
  setTimeout(()=>{ t.classList.remove('show'); t.style.borderLeft='4px solid var(--accent)'; }, 3000);
}

/* ======== Inicializaci√≥n UI ======== */
function initUI(){
  // Inicializar Firebase listeners y datos
  initializeFirebaseListeners();
  loadInitialFirebaseData();

  // Header content (respaldo con MENU_DATA)
  document.getElementById('coverImage').src = MENU_DATA.coverImage;
  document.getElementById('profileImage').src = MENU_DATA.profileImage;
  document.getElementById('headerRestaurantImage').src = MENU_DATA.coverImage;
  document.getElementById('profileName').textContent = MENU_DATA.restaurant;
  document.getElementById('profileSlogan').textContent = MENU_DATA.slogan;

  // Hours (respaldo)
  const hoursList = document.getElementById('hoursList');
  hoursList.innerHTML = '';
  MENU_DATA.hours.forEach(h => {
    const div = document.createElement('div');
    div.style.display='flex'; div.style.justifyContent='space-between'; div.style.padding='6px 0';
    div.innerHTML = `<div>${h.day}</div><div style="color:var(--text-muted)">${h.time}</div>`;
    hoursList.appendChild(div);
  });

  // Categories in sidebar (initial from MENU_DATA; will be overwritten by Firebase if present)
  renderCategoriesSidebarFallback();

  // Customer categories (home)
  renderCustomerCategories();

  // Menu Section (initial from MENU_DATA; will be overwritten by Firebase if present)
  renderMenu(MENU_DATA.dishes);

  // Cart badge
  updateCartUI();

  // Setup food tags filter
  setupFoodTagsFilter();

  // Update favorites list
  updateFavoritesList();

  // Events: sidebar open/close, cart open/close
  setupUiEvents();
}

/* ========== UI helpers (setup) ========== */
function setupUiEvents(){
  const hamburger = document.getElementById('hamburgerMenu');
  const sidebar = document.getElementById('sidebarNav');
  const overlay = document.getElementById('sidebarOverlay');
  hamburger.addEventListener('click', openSidebar);
  document.getElementById('closeSidebar').addEventListener('click', closeSidebar);
  overlay.addEventListener('click', closeSidebar);

  document.getElementById('cartIcon').addEventListener('click', openCart);
  document.getElementById('closeCart').addEventListener('click', closeCart);
  document.getElementById('cartOverlay').addEventListener('click', closeCart);

  document.getElementById('applyPriceFilter').addEventListener('click', applyFilters);
  document.getElementById('clearPriceFilter').addEventListener('click', () => {
    document.getElementById('minPrice').value = '';
    document.getElementById('maxPrice').value = '';
    state.selectedTags = [];
    document.querySelectorAll('.filter-tag').forEach(t=>t.classList.remove('selected'));
    renderMenu(firebaseMenuData.dishes.length>0 ? firebaseMenuData.dishes : MENU_DATA.dishes);
  });

  // Menu navigation
  document.getElementById('menuBtn').addEventListener('click', ()=>showView('menuView'));
  document.getElementById('homeBtn').addEventListener('click', ()=>showView('homeView'));
  document.getElementById('backBtn').addEventListener('click', ()=>showView('homeView'));
}

/* Sidebar open/close */
function openSidebar(){
  document.getElementById('sidebarNav').classList.add('open');
  document.getElementById('sidebarOverlay').classList.add('open');
}
function closeSidebar(){
  document.getElementById('sidebarNav').classList.remove('open');
  document.getElementById('sidebarOverlay').classList.remove('open');
}

/* Cart open/close */
function openCart(){
  document.getElementById('cartSidebar').classList.add('open');
  document.getElementById('cartOverlay').classList.add('open');
}
function closeCart(){
  document.getElementById('cartSidebar').classList.remove('open');
  document.getElementById('cartOverlay').classList.remove('open');
}

/* View switcher */
function showView(viewId){
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  const el = document.getElementById(viewId);
  if(el) el.classList.add('active');
}

/* ======== Firebase listeners & loaders (mejorados) ======== */

// Inicializar listeners de Firebase
function initializeFirebaseListeners() {
    console.log('üî• Iniciando listeners de Firebase...');

    // Info restaurante
    db.collection('restaurant').doc('info')
      .onSnapshot((doc) => {
        if (doc.exists) {
          const data = doc.data();
          console.log('üìù Info restaurante actualizada:', data);
          updateRestaurantInfo(data);
        }
      }, (err) => console.error('Error listener info:', err));

    // Contacto
    db.collection('restaurant').doc('contact')
      .onSnapshot((doc) => {
        if (doc.exists) {
          console.log('üìû Contacto actualizado:', doc.data());
          updateContactInfo(doc.data());
        }
      });

    // Horarios
    db.collection('restaurant').doc('hours')
      .onSnapshot((doc) => {
        if (doc.exists) {
          console.log('üïí Horarios actualizados:', doc.data());
          updateHours(doc.data().hours || []);
        }
      });

    // Men√∫ - platos
    db.collection('menu').doc('dishes')
        .onSnapshot((doc) => {
            if (doc.exists) {
                const data = doc.data();
                console.log('üçΩÔ∏è Men√∫ actualizado (dishes):', data);
                firebaseMenuData.dishes = data.dishes || [];
                updateMenuWithFirebaseData();
            } else {
                // si no existe doc, dej√° los datos tal como est√°n (fallback)
                console.warn('doc menu/dishes no existe');
            }
        }, (err) => { console.error('Error escuchando menu/dishes:', err); });

    // Men√∫ - categor√≠as
    db.collection('menu').doc('categories')
        .onSnapshot((doc) => {
            if (doc.exists) {
                const data = doc.data();
                console.log('üìÇ Categor√≠as actualizadas:', data);
                firebaseMenuData.categories = data.categories || [];
                updateMenuWithFirebaseData();
            } else {
                console.warn('doc menu/categories no existe');
            }
        }, (err) => { console.error('Error escuchando menu/categories:', err); });
}

// Cargar datos iniciales de Firebase (una pasada)
function loadInitialFirebaseData() {
    console.log('üì• Cargando datos iniciales de Firebase...');

    Promise.all([
      db.collection('menu').doc('dishes').get(),
      db.collection('menu').doc('categories').get(),
      db.collection('restaurant').doc('info').get(),
      db.collection('restaurant').doc('contact').get(),
      db.collection('restaurant').doc('hours').get()
    ]).then(([dishesDoc,categoriesDoc,infoDoc,contactDoc,hoursDoc])=>{
      if (infoDoc && infoDoc.exists) updateRestaurantInfo(infoDoc.data());
      if (contactDoc && contactDoc.exists) updateContactInfo(contactDoc.data());
      if (hoursDoc && hoursDoc.exists) updateHours(hoursDoc.data().hours || []);

      if (dishesDoc && dishesDoc.exists) firebaseMenuData.dishes = dishesDoc.data().dishes || [];
      if (categoriesDoc && categoriesDoc.exists) firebaseMenuData.categories = categoriesDoc.data().categories || [];

      // Si ambos existen y tienen items, renderizamos desde Firebase; si no, fallback a MENU_DATA
      if (firebaseMenuData.dishes.length > 0 && firebaseMenuData.categories.length > 0) {
        updateMenuWithFirebaseData();
      } else {
        console.log('üîÅ Usando datos locales de respaldo (MENU_DATA)');
        // renderCategorySidebar fall back and render menu already done in initUI
      }
    }).catch(err=>{
      console.error('Error cargando datos iniciales Firebase:', err);
    });
}

/* ======== Actualizadores que integran Firebase + fallback ======== */

// Actualizar informaci√≥n del restaurante desde Firebase
function updateRestaurantInfo(data) {
    if (!data) return;
    if (data.name) {
        const headerTitle = document.getElementById('headerTitle');
        const profileName = document.getElementById('profileName');
        if (headerTitle) headerTitle.textContent = data.name;
        if (profileName) profileName.textContent = data.name;
        document.title = data.name + " ‚Äî Men√∫ Digital";
    }
    if (data.slogan) {
        const headerSlogan = document.getElementById('headerSlogan');
        const profileSlogan = document.getElementById('profileSlogan');
        if (headerSlogan) headerSlogan.textContent = data.slogan;
        if (profileSlogan) profileSlogan.textContent = data.slogan;
    }
}

// Actualizar informaci√≥n de contacto desde Firebase
function updateContactInfo(data) {
    if (!data) return;
    if (data.phone) {
        const phoneLinks = document.querySelectorAll('.contact-link');
        phoneLinks.forEach(link => {
            if (link.href.includes('wa.me')) {
                link.href = `https://wa.me/${data.phone.replace(/\D/g, '')}`;
                link.textContent = data.phone;
            }
        });
    }
    if (data.instagram) {
        const instagramLinks = document.querySelectorAll('.contact-link');
        instagramLinks.forEach(link => {
            if (link.href.includes('instagram.com')) {
                link.href = `https://instagram.com/${data.instagram.replace('@', '')}`;
                link.textContent = data.instagram;
            }
        });
    }
}

// Actualizar horarios desde Firebase
function updateHours(hours) {
    if (!hours) return;
    const hoursList = document.getElementById('hoursList');
    if (hoursList) {
        hoursList.innerHTML = '';
        hours.forEach(h => {
            const div = document.createElement('div');
            div.style.display='flex'; 
            div.style.justifyContent='space-between'; 
            div.style.padding='6px 0';
            div.innerHTML = `<div>${h.day}</div><div style="color:var(--text-muted)">${h.time}</div>`;
            hoursList.appendChild(div);
        });
    }
}

/* ======== Reemplazo principal: actualizar men√∫ con datos de Firebase ======== */

function updateMenuWithFirebaseData() {
  console.log('üîÑ Actualizando men√∫ con datos de Firebase...');
  const dishes = firebaseMenuData.dishes || [];
  const categories = firebaseMenuData.categories || [];

  // Si no hay datos en Firebase, no fallamos: usamos MENU_DATA como respaldo
  if ((!dishes || dishes.length === 0) || (!categories || categories.length === 0)) {
    console.warn('‚ö†Ô∏è Firebase no tiene datos completos (dishes / categories). Manteniendo fallback local.');
    // Si al menos hay platos, renderizalos; sino deja el men√∫ est√°tico
    if (dishes.length > 0 && categories.length > 0) {
      renderMenuFromFirebase(dishes);
      updateCategoriesInSidebar(categories);
    } else {
      // fallback: renderizar MENU_DATA
      renderMenu(MENU_DATA.dishes);
      renderCategoriesSidebarFallback();
    }
    return;
  }

  // Si llegamos ac√°, Firebase tiene datos v√°lidos: renderizamos todo desde Firebase
  renderMenuFromFirebase(dishes);
  updateCategoriesInSidebar(categories);
}

/* Actualiza la barra lateral con categor√≠as desde Firebase */
function updateCategoriesInSidebar(categories) {
  const categoriesSidebar = document.getElementById('categoriesSidebar');
  if (!categoriesSidebar) return;

  categoriesSidebar.innerHTML = '';

  categories.forEach(cat => {
    if (cat.subcategories) {
      cat.subcategories.forEach(sub => {
        const btn = document.createElement('button');
        btn.className = 'nav-btn';
        btn.textContent = sub.name;
        btn.dataset.cat = sub.id;
        btn.addEventListener('click', () => {
          showCategoryFromFirebase(sub.id);
          closeSidebar();
        });
        categoriesSidebar.appendChild(btn);
      });
    } else {
      const btn = document.createElement('button');
      btn.className = 'nav-btn';
      btn.textContent = cat.name;
      btn.dataset.cat = cat.id;
      btn.addEventListener('click', () => {
        showCategoryFromFirebase(cat.id);
        closeSidebar();
      });
      categoriesSidebar.appendChild(btn);
    }
  });
}

/* Fallback para mostrar categor√≠as desde MENU_DATA (cuando Firebase vac√≠o) */
function renderCategoriesSidebarFallback(){
  const categoriesSidebar = document.getElementById('categoriesSidebar');
  if (!categoriesSidebar) return;
  categoriesSidebar.innerHTML = '';
  MENU_DATA.categories.forEach(c => {
    if (c.subcategories) {
      c.subcategories.forEach(sub => {
        const btn = document.createElement('button');
        btn.className = 'nav-btn';
        btn.textContent = sub.name;
        btn.dataset.cat = sub.id;
        btn.addEventListener('click', () => {
          showCategory(sub.id);
          closeSidebar();
        });
        categoriesSidebar.appendChild(btn);
      });
    } else {
      const btn = document.createElement('button');
      btn.className = 'nav-btn';
      btn.textContent = c.name;
      btn.dataset.cat = c.id;
      btn.addEventListener('click', () => {
        showCategory(c.id);
        closeSidebar();
      });
      categoriesSidebar.appendChild(btn);
    }
  });
}

/* ======== Render desde Firebase ======== */

function renderMenuFromFirebase(dishes) {
    const menuSection = document.getElementById('menuSection');
    if (!menuSection) return;
    menuSection.innerHTML = '';

    // Organizar platos por categor√≠a usando firebaseMenuData.categories
    const dishesByCategory = {};
    firebaseMenuData.categories.forEach(cat => {
        if (cat.subcategories) {
            cat.subcategories.forEach(sub => {
                dishesByCategory[sub.id] = dishes.filter(d => d.category === sub.id);
            });
        } else {
            dishesByCategory[cat.id] = dishes.filter(d => d.category === cat.id);
        }
    });

    Object.keys(dishesByCategory).forEach(catId => {
        const catDishes = dishesByCategory[catId];
        if (!catDishes || catDishes.length === 0) return;

        // Encontrar el nombre de la categor√≠a
        let categoryName = '';
        firebaseMenuData.categories.forEach(cat => {
            if (cat.subcategories) {
                const sub = cat.subcategories.find(s => s.id === catId);
                if (sub) categoryName = sub.name;
            } else if (cat.id === catId) {
                categoryName = cat.name;
            }
        });

        const catSection = document.createElement('section');
        catSection.className = 'category-section';
        catSection.innerHTML = `
            <div class="category-header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                <div>
                    <div class="category-title" style="color:var(--accent)">${categoryName}</div>
                    <div class="category-count" style="background:var(--surface-light);color:var(--text-muted);padding:4px 8px;border-radius:12px;font-size:12px">${catDishes.length} items</div>
                </div>
            </div>
            <div class="category-carousel" id="carousel_${catId}"></div>
        `;
        menuSection.appendChild(catSection);

        const carousel = catSection.querySelector(`#carousel_${catId}`);
        const displayedDishes = catDishes.slice(0, 2);

        displayedDishes.forEach(d => {
            const card = document.createElement('div');
            card.className='dish-card category-carousel-item';
            card.innerHTML = `
                <div class="dish-image"><img src="${d.img || ''}" alt="${d.name}"></div>
                <div class="dish-content">
                    <div>
                        <div class="dish-header"><div class="dish-name">${d.name}</div><div class="dish-price">$${d.price}</div></div>
                        <div class="dish-description" style="color:var(--text-muted);font-size:13px">${d.description || ''}</div>
                        ${d.tags && d.tags.length > 0 ? `<div class="dish-tags" style="display:flex;gap:4px;margin-top:4px;flex-wrap:wrap">${d.tags.map(tag => `<span style="background:var(--surface);color:var(--accent);padding:2px 6px;border-radius:10px;font-size:10px;border:1px solid var(--accent)">${tag}</span>`).join('')}</div>` : ''}
                    </div>
                    <div class="dish-actions">
                        <div style="display:flex;gap:8px;align-items:center">
                            <button class="qty-btn" data-action="fav" title="Favorito"><i class="fas fa-heart"></i></button>
                        </div>
                        <div style="display:flex;gap:8px;align-items:center">
                            <button class="add-to-cart-btn" data-id="${d.id}"><i class="fas fa-cart-plus"></i> Agregar</button>
                        </div>
                    </div>
                </div>
            `;

            card.addEventListener('click', (e) => {
                if (!e.target.closest('button')) {
                    document.querySelectorAll('.dish-card').forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                    openDishDetailFromFirebase(d.id);
                }
            });

            // favorite button
            const favBtn = card.querySelector('[data-action="fav"]');
            favBtn.addEventListener('click', (ev) => {
                ev.stopPropagation();
                toggleFavorite(d.id, ev.currentTarget);
            });

            // add to cart
            const addBtn = card.querySelector('.add-to-cart-btn');
            addBtn.addEventListener('click', (ev) => {
                ev.stopPropagation();
                addToCart(d.id, 1, d); // pass object optional
            });

            carousel.appendChild(card);
        });
    });
}

/* ======== Render men√∫ desde datos locales (original) - lo mantenemos como respaldo ======== */
function renderMenu(dishes){
  const menuSection = document.getElementById('menuSection');
  menuSection.innerHTML = '';

  // Organizar platos por categor√≠a
  const dishesByCategory = {};
  MENU_DATA.categories.forEach(cat => {
    if (cat.subcategories) {
      cat.subcategories.forEach(sub => {
        dishesByCategory[sub.id] = dishes.filter(d => d.category === sub.id);
      });
    } else {
      dishesByCategory[cat.id] = dishes.filter(d => d.category === cat.id);
    }
  });

  // Crear secciones para cada categor√≠a
  Object.keys(dishesByCategory).forEach(catId => {
    const catDishes = dishesByCategory[catId];
    if (!catDishes || catDishes.length === 0) return;
    
    // Encontrar el nombre de la categor√≠a
    let categoryName = '';
    MENU_DATA.categories.forEach(cat => {
      if (cat.subcategories) {
        const sub = cat.subcategories.find(s => s.id === catId);
        if (sub) categoryName = sub.name;
      } else if (cat.id === catId) {
        categoryName = cat.name;
      }
    });
    
    const catSection = document.createElement('section');
    catSection.className = 'category-section';
    catSection.innerHTML = `
      <div class="category-header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div>
          <div class="category-title" style="color:var(--accent)">${categoryName}</div>
          <div class="category-count" style="background:var(--surface-light);color:var(--text-muted);padding:4px 8px;border-radius:12px;font-size:12px">${catDishes.length} items</div>
        </div>
      </div>
      <div class="category-carousel" id="carousel_${catId}"></div>
    `;
    menuSection.appendChild(catSection);

    const carousel = catSection.querySelector(`#carousel_${catId}`);
    const displayedDishes = catDishes.slice(0, 2);
    
    displayedDishes.forEach(d => {
      const card = document.createElement('div');
      card.className='dish-card category-carousel-item';
      card.innerHTML = `
        <div class="dish-image"><img src="${d.img}" alt="${d.name}"></div>
        <div class="dish-content">
          <div>
            <div class="dish-header"><div class="dish-name">${d.name}</div><div class="dish-price">$${d.price}</div></div>
            <div class="dish-description" style="color:var(--text-muted);font-size:13px">${d.description}</div>
            ${d.tags.length > 0 ? `<div class="dish-tags" style="display:flex;gap:4px;margin-top:4px;flex-wrap:wrap">${d.tags.map(tag => `<span style="background:var(--surface);color:var(--accent);padding:2px 6px;border-radius:10px;font-size:10px;border:1px solid var(--accent)">${tag}</span>`).join('')}</div>` : ''}
          </div>
          <div class="dish-actions">
            <div style="display:flex;gap:8px;align-items:center">
              <button class="qty-btn" data-action="fav" title="Favorito"><i class="fas fa-heart"></i></button>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
              <button class="add-to-cart-btn" data-id="${d.id}"><i class="fas fa-cart-plus"></i> Agregar</button>
            </div>
          </div>
        </div>
      `;
      // click image or card to open detail
      card.addEventListener('click', (e) => {
        if (!e.target.closest('button')) {
          document.querySelectorAll('.dish-card').forEach(c => c.classList.remove('selected'));
          card.classList.add('selected');
          openDishDetail(d.id);
        }
      });
      // favorite
      card.querySelector('[data-action="fav"]').addEventListener('click', (e)=>{
        e.stopPropagation();
        toggleFavorite(d.id, e.currentTarget);
      });
      // add to cart
      card.querySelector('.add-to-cart-btn').addEventListener('click', (e)=>{
        e.stopPropagation();
        addToCart(d.id,1);
      });
      carousel.appendChild(card);
    });
  });
}

/* ======== Mostrar categor√≠a desde fallback (MENU_DATA) ======== */
function showCategory(catId) {
  const filtered = MENU_DATA.dishes.filter(d => d.category === catId);
  if (filtered.length > 0) {
    renderMenu(filtered);
    showView('menuView');
  } else {
    toast('No hay platos en esta categor√≠a', 'error');
  }
}

/* ======== Mostrar categor√≠a desde Firebase ======== */
function showCategoryFromFirebase(catId) {
  const filtered = (firebaseMenuData.dishes || []).filter(d => d.category === catId);
  if (filtered.length > 0) {
    renderMenuFromFirebase(filtered);
    showView('menuView');
  } else {
    toast('No hay platos en esta categor√≠a', 'error');
  }
}

/* ======== Detalle de plato (fallback) ======== */
function openDishDetail(dishId){
  const d = MENU_DATA.dishes.find(x => x.id === dishId);
  if (!d) return;
  openDishDetailModal(d);
}

/* Detalle desde Firebase */
function openDishDetailFromFirebase(dishId){
  const d = (firebaseMenuData.dishes || []).find(x => x.id === dishId);
  if (!d) return;
  openDishDetailModal(d);
}

/* Abre modal de detalle usando objeto de plato */
function openDishDetailModal(d){
  document.getElementById('detailImage').src = d.img || '';
  document.getElementById('detailName').textContent = d.name || '';
  document.getElementById('detailPrice').textContent = `$${d.price || 0}`;
  document.getElementById('detailDescription').textContent = d.description || '';
  const tagsContainer = document.getElementById('detailTags');
  tagsContainer.innerHTML = '';
  if (d.tags && d.tags.length>0){
    d.tags.forEach(tag => {
      const s = document.createElement('span');
      s.style.background = 'var(--surface)';
      s.style.color = 'var(--accent)';
      s.style.padding = '2px 6px';
      s.style.borderRadius = '10px';
      s.style.fontSize = '10px';
      s.style.border = '1px solid var(--accent)';
      s.style.marginRight = '6px';
      s.textContent = tag;
      tagsContainer.appendChild(s);
    });
  }
  // reset qty
  document.getElementById('detailQuantity').textContent = '1';
  // show modal
  const modal = document.getElementById('dishDetailModal');
  modal.classList.add('open');

  // wire modal buttons
  document.getElementById('detailDecrease').onclick = ()=>{
    const qEl = document.getElementById('detailQuantity');
    let q = parseInt(qEl.textContent || '1', 10);
    q = Math.max(1, q-1); qEl.textContent = q;
  };
  document.getElementById('detailIncrease').onclick = ()=>{
    const qEl = document.getElementById('detailQuantity');
    let q = parseInt(qEl.textContent || '1', 10);
    q = q+1; qEl.textContent = q;
  };
  document.getElementById('detailAddToCart').onclick = ()=>{
    const q = parseInt(document.getElementById('detailQuantity').textContent || '1', 10);
    addToCart(d.id, q, d);
    modal.classList.remove('open');
  };
  document.getElementById('closeDetail').onclick = ()=>{ modal.classList.remove('open'); };
  document.getElementById('detailReset').onclick = ()=>{
    document.getElementById('detailQuantity').textContent = '1';
  };
  document.getElementById('detailFavorite').onclick = (e)=>{
    toggleFavorite(d.id, e.currentTarget);
  };
}

/* ======== Carrito ======== */
function addToCart(dishId, quantity=1, dishObj=null){
  // dishObj optional to include image/price quickly
  if (!state.cart[dishId]) {
    state.cart[dishId] = { qty: 0 };
  }
  state.cart[dishId].qty += quantity;

  // attach some metadata if not present
  if (dishObj) {
    state.cart[dishId].name = dishObj.name;
    state.cart[dishId].price = dishObj.price;
    state.cart[dishId].img = dishObj.img;
  } else {
    // try to find in firebase or local list
    const d = (firebaseMenuData.dishes || []).concat(MENU_DATA.dishes || []).find(x=>x.id===dishId);
    if (d) {
      state.cart[dishId].name = d.name;
      state.cart[dishId].price = d.price;
      state.cart[dishId].img = d.img;
    }
  }

  saveState();
  updateCartUI();
  toast('A√±adido al carrito');
}

function updateCartUI(){
  const cartItems = document.getElementById('cartItems');
  cartItems.innerHTML = '';
  let total = 0;
  let count = 0;
  Object.keys(state.cart).forEach(id=>{
    const item = state.cart[id];
    const lineTotal = (item.price || 0) * item.qty;
    total += lineTotal;
    count += item.qty;
    const row = document.createElement('div');
    row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center';
    row.style.padding='8px 0'; row.style.borderBottom='1px solid var(--border)';
    row.innerHTML = `
      <div style="display:flex;gap:8px;align-items:center">
        <img src="${item.img || ''}" style="width:50px;height:50px;object-fit:cover;border-radius:6px">
        <div>
          <div style="font-weight:700">${item.name || ''}</div>
          <div style="color:var(--text-muted);font-size:12px">$${item.price || 0} x ${item.qty}</div>
        </div>
      </div>
      <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
        <div style="font-weight:700">$${lineTotal}</div>
        <div style="display:flex;gap:6px">
          <button class="nav-btn" onclick="changeCartQty('${id}', -1)">-</button>
          <button class="nav-btn" onclick="changeCartQty('${id}', 1)">+</button>
          <button class="nav-btn" onclick="removeFromCart('${id}')"><i class="fas fa-trash"></i></button>
        </div>
      </div>
    `;
    cartItems.appendChild(row);
  });

  document.getElementById('cartTotal').textContent = `$${total}`;
  document.getElementById('cartCount').textContent = `${Object.keys(state.cart).reduce((s,k)=>s+state.cart[k].qty,0)}`;
}

function changeCartQty(id, delta){
  if (!state.cart[id]) return;
  state.cart[id].qty += delta;
  if (state.cart[id].qty <= 0) delete state.cart[id];
  saveState();
  updateCartUI();
}

function removeFromCart(id){
  if (state.cart[id]) delete state.cart[id];
  saveState();
  updateCartUI();
}

/* ======== Favoritos ======== */
function toggleFavorite(dishId, btnEl){
  if(state.favorites[dishId]){ 
    delete state.favorites[dishId]; 
    toast('Eliminado de favoritos'); 
    if (btnEl) btnEl.classList.remove('active'); 
  } else { 
    state.favorites[dishId]=true; 
    toast('A√±adido a favoritos'); 
    if (btnEl) btnEl.classList.add('active'); 
  }
  saveState();
  updateFavoritesList();
}

function updateFavoritesList() {
  const favoritesList = document.getElementById('favoritesList');
  favoritesList.innerHTML = '';
  
  const allDishes = (firebaseMenuData.dishes && firebaseMenuData.dishes.length>0) ? firebaseMenuData.dishes.concat(MENU_DATA.dishes) : MENU_DATA.dishes;
  const favoriteDishes = Object.keys(state.favorites)
    .map(id => allDishes.find(d => d.id === id))
    .filter(d => d); // Filtrar undefined
  
  if (favoriteDishes.length === 0) {
    favoritesList.innerHTML = '<div style="color:var(--text-muted);padding:8px">No hay platos favoritos</div>';
    return;
  }
  
  favoriteDishes.forEach(dish => {
    const item = document.createElement('div');
    item.className = 'favorite-item';
    item.innerHTML = `
      <div style="display:flex;align-items:center;gap:8px">
        <img src="${dish.img}" style="width:40px;height:40px;object-fit:cover;border-radius:6px">
        <div>
          <div style="font-weight:700">${dish.name}</div>
          <div style="color:var(--text-muted);font-size:12px">$${dish.price}</div>
        </div>
      </div>
      <div class="favorite-vote">
        <button class="vote-btn" data-action="downvote" data-id="${dish.id}"><i class="fas fa-chevron-down"></i></button>
        <span class="vote-count">${state.dishVotes[dish.id] || 0}</span>
        <button class="vote-btn" data-action="upvote" data-id="${dish.id}"><i class="fas fa-chevron-up"></i></button>
      </div>
    `;
    favoritesList.appendChild(item);

    // votes
    const up = item.querySelector('[data-action="upvote"]');
    const down = item.querySelector('[data-action="downvote"]');
    up.addEventListener('click', ()=>{ state.dishVotes[dish.id] = (state.dishVotes[dish.id]||0) + 1; saveState(); updateFavoritesList(); });
    down.addEventListener('click', ()=>{ state.dishVotes[dish.id] = (state.dishVotes[dish.id]||0) - 1; saveState(); updateFavoritesList(); });
  });
}

/* ======== Filtros (etiquetas) ======== */
function setupFoodTagsFilter() {
  document.querySelectorAll('.filter-tag').forEach(tag => {
    tag.addEventListener('click', () => {
      tag.classList.toggle('selected');
      const tagValue = tag.dataset.tag;
      
      if (tag.classList.contains('selected')) {
        state.selectedTags.push(tagValue);
      } else {
        state.selectedTags = state.selectedTags.filter(t => t !== tagValue);
      }
      
      applyFilters();
    });
  });
}

function applyFilters() {
  let sourceDishes = (firebaseMenuData.dishes && firebaseMenuData.dishes.length>0) ? firebaseMenuData.dishes : MENU_DATA.dishes;
  let filteredDishes = sourceDishes.slice();
  
  // Apply price filter
  const minPrice = Number(document.getElementById('minPrice').value) || 0;
  const maxPrice = Number(document.getElementById('maxPrice').value) || Infinity;
  filteredDishes = filteredDishes.filter(d => d.price >= minPrice && d.price <= maxPrice);
  
  // Apply tag filter
  if (state.selectedTags.length > 0) {
    filteredDishes = filteredDishes.filter(d => {
      return state.selectedTags.some(tag => d.tags && d.tags.includes(tag));
    });
  }
  
  // Render accordingly
  if (firebaseMenuData.dishes && firebaseMenuData.dishes.length>0) {
    renderMenuFromFirebase(filteredDishes);
  } else {
    renderMenu(filteredDishes);
  }
}

/* ======== Utilities: render customer categories (home) ======== */
function renderCustomerCategories(){
  const customerCategories = document.getElementById('customerCategories');
  customerCategories.innerHTML = '';
  
  const firstNames = ['Juan', 'Mar√≠a', 'Carlos', 'Ana', 'Luis', 'Laura', 'Pedro', 'Sof√≠a', 'Diego', 'Elena'];
  const lastNames = ['G√≥mez', 'Rodr√≠guez', 'Fern√°ndez', 'L√≥pez', 'Mart√≠nez', 'P√©rez', 'Garc√≠a', 'S√°nchez', 'Romero', 'Torres'];
  
  const customerCategoriesData = [
    { name: 'Clientes Frecuentes', color: '#d4af37' },
    { name: 'Clientes VIP', color: '#c0c0c0' },
    { name: 'Nuevos Clientes', color: '#cd7f32' }
  ];
  
  customerCategoriesData.forEach(category => {
    const section = document.createElement('div');
    section.className='customer-category';
    section.innerHTML = `<h3 style="color:${category.color}">${category.name}</h3><div class="customer-list" id="list_${category.name.replace(/\s+/g, '')}"></div>`;
    customerCategories.appendChild(section);
    
    const list = section.querySelector(`#list_${category.name.replace(/\s+/g, '')}`);
    for (let i = 0; i < 3; i++) {
      const firstName = firstNames[Math.floor(Math.random() * firstNames.length)];
      const lastName = lastNames[Math.floor(Math.random() * lastNames.length)];
      const score = Math.floor(Math.random() * 301) + 50;
      const item = document.createElement('div');
      item.className = 'customer-item';
      item.innerHTML = `
        <div class="customer-name">${firstName} ${lastName}</div>
        <div class="customer-score">${score} pts</div>
      `;
      list.appendChild(item);
    }
  });
}

/* ======== Inicializar todo al cargar la p√°gina ======== */
document.addEventListener('DOMContentLoaded', ()=>{
  initUI();
});
</script>
</body>
</html>
